<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>🧭 مراجعة التوجيه  – Routing, Static & Default</title>
  <style>
    :root{ --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#9ca3af; --brand:#38bdf8; --accent:#22c55e; --warn:#f59e0b; --danger:#ef4444; }
    *{box-sizing:border-box}
    body{ margin:0; background:linear-gradient(180deg,#0b1220,#0f172a 30%,#0b1220); color:var(--ink); font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Naskh Arabic UI",Tahoma; min-height:100dvh; display:flex; align-items:center; justify-content:center; padding:24px; }
    .app{ width:min(1000px,100%) }
    header{display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:16px}
    header h1{font-size:clamp(18px,3vw,24px); margin:0; letter-spacing:.3px; color:var(--brand)}
    .controls{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
    button{ background:#0b1220; color:var(--ink); border:1px solid #263042; border-radius:12px; padding:10px 14px; cursor:pointer; font-weight:600; transition:.2s }
    button:hover{ transform:translateY(-1px); background:#0b1426 }
    button.primary{ border-color:var(--brand) } button.good{ border-color:var(--accent) } button.bad{ border-color:var(--danger) }
    input[type="number"],input[type="text"]{ background:#0b1220; color:var(--ink); border:1px solid #263042; border-radius:10px; padding:8px 10px; width:100% }
    .card{ perspective:1200px; isolation:isolate; height:clamp(280px,42vh,420px); background:transparent; border-radius:16px; position:relative }
    .card-inner{ position:absolute; inset:0; border-radius:16px; transform-style:preserve-3d; transition:transform .5s cubic-bezier(.2,.8,.2,1) }
    .face{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; text-align:center; padding:28px; background:radial-gradient(1200px 400px at 100% 0%,#0b1426,var(--card)); border:1px solid #1f2937; border-radius:16px; backface-visibility:hidden; box-shadow:0 10px 40px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03) }
    .face.back{ transform:rotateY(180deg); background:#0f1a2e }
    .flipped .card-inner{ transform:rotateY(180deg) }
    .meta{display:flex; align-items:center; gap:10px; opacity:.9; font-size:14px}
    .pill{border:1px dashed #2b3450; padding:4px 10px; border-radius:999px}
    .muted{color:var(--muted)}
    .progress{height:10px; background:#162033; border-radius:999px; overflow:hidden; border:1px solid #263042; margin-top:12px}
    .bar{height:100%; width:0%; background:linear-gradient(90deg,var(--brand),#60a5fa); transition:width .3s ease}
    .panel{background:#0b1426; border:1px solid #263042; border-radius:16px; padding:16px}
    .small{font-size:12px; opacity:.85}
    .hidden{display:none}
    .exbox{ margin-top:12px; padding:14px 16px; border-radius:14px; line-height:1.7; border:1px solid #26425a; background:linear-gradient(180deg,#0b1426,#0c162a); box-shadow: inset 0 1px 0 rgba(255,255,255,.04), 0 8px 24px rgba(0,0,0,.25) }
    .exbox h4{margin:0 0 6px 0; font-size:14px; color:#7dd3fc}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#0a1220; border:1px solid #263042; border-radius:6px; padding:0 6px}
    .quizbox{ margin-top:12px; padding:16px; border-radius:14px; border:1px solid #334155; background:linear-gradient(180deg,#0c1528,#0f1a30); box-shadow: inset 0 1px 0 rgba(255,255,255,.04), 0 8px 24px rgba(0,0,0,.25) }
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .score{font-weight:700}
    .tag{border:1px solid #2b3450; padding:2px 8px; border-radius:999px; font-size:12px}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>🧭 مراجعة التوجيه  – Routing, Static & Default <br>م. نبيل الشويكان</h1>
      <div class="controls">
        <button id="btnFlip" class="primary" title="المسطرة: مسافة">اقلب البطاقة ▯</button>
        <button id="btnPrev" title="الأسهم">◀ السابقة</button>
        <button id="btnNext" title="الأسهم">التالي ▶</button>
        <button id="btnGood" class="good" title="رقم 1">عرفتها ✓</button>
        <button id="btnBad" class="bad" title="رقم 2">لا، أعِدها ✗</button>
        <button id="btnShuffle" title="خلط البطاقات">🔀 خلط</button>
        <span class="tag" id="timer" title="الوقت المتبقي" style="margin-inline-start:8px">⏱️ —</span>
      </div>
    </header>

    <section class="panel" id="studyView">
      <div class="meta" style="margin-bottom:10px">
        <span class="pill" id="deckName">Routing Concepts / Static / Default / IPv6 / AD / ECMP / Verification / Troubleshooting</span>
        <span class="muted">(<span id="idx">1</span>/<span id="total">1</span>)</span>
      </div>

      <div class="card" id="card">
        <div class="card-inner" id="cardInner">
          <div class="face front" id="front"></div>
          <div class="face back" id="back"></div>
        </div>
      </div>

      <div id="ex" class="exbox hidden">
        <h4>شرح مختصر</h4>
        <div id="exText"></div>
      </div>

      <div class="progress" aria-label="نسبة التقدم">
        <div class="bar" id="bar"></div>
      </div>
      <p class="small muted">اختصارات: مسافة (قلب)، الأسهم يمين/يسار (تنقّل)، 1 (صح)، 2 (إعادة).</p>
    </section>

    <section class="panel quizbox" id="quizSetup">
      <div class="row">
        <strong>🎯 وضع اختبار سريع</strong>
        <span class="muted">— اختر مدته ثم ابدأ</span>
      </div>
      <div class="row" style="margin-top:8px">
        <label for="mins" class="muted">الدقائق:</label>
        <input id="mins" type="number" min="1" max="60" value="12" style="width:90px" />
        <button id="btnStartQuiz" class="primary">ابدأ الاختبار</button>
        <span class="muted" id="quizInfo"></span>
      </div>
    </section>

    <section class="panel quizbox hidden" id="quizView">
      <div class="row" style="justify-content:space-between">
        <div>
          <span class="score">النتيجة: <span id="score">0</span>/<span id="qtotal">0</span></span>
          <span class="tag" style="margin-inline-start:6px">السؤال <span id="qidx">1</span></span>
        </div>
        <div class="muted">⏱️ <span id="quizTimer">—</span></div>
      </div>

      <div class="meta" style="margin-top:10px"><span class="pill" id="qFront"></span></div>

      <div class="row" style="margin-top:10px">
        <input id="ansInput" type="text" placeholder="اكتب إجابة قصيرة (كلمة/كلمتين)…" />
        <button id="btnSubmit" class="primary">تحقّق</button>
        <button id="btnSkip">تجاوز</button>
        <div id="tfBtns" class="row hidden">
          <button id="btnTrue" class="good">صح</button>
          <button id="btnFalse" class="bad">خطأ</button>
        </div>
      </div>
      <div id="quizFeedback" class="small" style="margin-top:8px"></div>
    </section>

    <section class="panel hidden" id="quizSummary">
      <h3 style="margin:0">📊 نتيجة الاختبار</h3>
      <p class="muted" id="summaryText"></p>
      <div class="row"><button id="btnRetry" class="primary">إعادة الاختبار</button><button id="btnBackStudy">العودة للمراجعة</button></div>
    </section>

    <footer style="margin-top:14px" class="muted small">
      يعمل بالكامل دون مكتبات خارجية. يتم حفظ تقدمك محليًا في المتصفح.
    </footer>
  </div>

  <script>
    // ===== 1) بطاقات: 90 سؤال (عربي + English) =====
    const cards = [
      // A) Basics
      {front:'ما هو التوجيه Routing؟',back:'اختيار المسار الأفضل',ex:'يحدد Best Path لحزم البيانات Data Packets وفق جدول التوجيه Routing Table.'},
      {front:'وظيفة الموجّه Router؟',back:'توجيه الرزم',ex:'يقرأ عناوين Layer 3 (IPv4/IPv6) ويقرر Next-Hop المناسب.'},
      {front:'ما جدول التوجيه Routing Table؟',back:'خريطة مسارات',ex:'قوائم بالوجهات Prefixes، وجهة تالية Next-Hop، والواجهة الخارجة.'},
      {front:'قاعدة LPM (Longest Prefix Match) تعني…',back:'الأطول يفوز',ex:'أكثر بادئة تحديدًا Prefix Length تستخدم أولًا.'},
      {front:'Administrative Distance (AD) هو…',back:'ثقة المصدر',ex:'رقم يفضّل مصدر المسار؛ الأقل قيمةً أكثر ثقة.'},
      {front:'Metric داخل البروتوكول يعني…',back:'كلفة المسار',ex:'يُستخدم لترجيح المسارات داخل نفس البروتوكول.'},
      {front:'Connected Route (C) يعني…',back:'شبكة مباشرة',ex:'شبكة على واجهة فعّالة؛ AD=0.'},
      {front:'Local Route (L) يعني…',back:'عنوان الواجهة',ex:'عنوان IP للواجهة نفسها على الراوتر.'},
      {front:'Static Route (S) يعني…',back:'مسار يدوي',ex:'تمت إضافته يدويًا بواسطة المسؤول.'},
      {front:'Gateway of Last Resort هو…',back:'المخرج الافتراضي',ex:'يستخدم عند عدم وجود تطابق محدد لأي وجهة.'},

      // B) Static & Default
      {front:'صيغة مسار ثابت IPv4؟',back:'ip route NET MASK NH',ex:'IP Route <network> <mask> <next-hop | exit-int>.'},
      {front:'قيمة AD الافتراضية للـ Static؟',back:'1',ex:'أعلى ثقة من OSPF(110) وRIP(120).'},
      {front:'Floating Static Route هو…',back:'احتياطي',ex:'Static بــ AD أعلى للعمل عند فشل المسار الأساسي.'},
      {front:'Default Route IPv4؟',back:'0.0.0.0/0',ex:'ip route 0.0.0.0 0.0.0.0 <NH>.'},
      {front:'Default Route IPv6؟',back:'::/0',ex:'ipv6 route ::/0 <NH>.'},
      {front:'هل يتغلب Default على /24؟',back:'لا',ex:'LPM يفضّل الأكثر تحديدًا.'},
      {front:'Static مع واجهة فقط (Exit-Int)…',back:'Point-to-Point',ex:'أفضل في وصلات P2P؛ وإلا قد يسبب ARP زائد.'},
      {front:'ECMP للثابت ممكن؟',back:'نعم',ex:'مساران ثابتان لنفس البادئة وAD متساوٍين.'},
      {front:'Null0 Route يعني…',back:'إسقاطٌ مقصود',ex:'يمنع تسريب المرور غير المرغوب فيه ويكبح الحلقات.'},
      {front:'Route Summarization (تلخيص)…',back:'تقليل الإدخالات',ex:'دمج عدة شبكات ضمن Prefix أوسع لتبسيط الجدول.'},

      // C) Verification
      {front:'أمر عرض كامل IPv4؟',back:'show ip route',ex:'يسرد جميع المسارات حسب المصدر.'},
      {front:'عرض مسارات Static فقط؟',back:'show ip route static',ex:'تصفية جدول التوجيه على النوع S.'},
      {front:'تحديد مسار لعنوان معيّن؟',back:'show ip route A.B.C.D',ex:'يعرض المسار الأفضل لذلك العنوان.'},
      {front:'عرض IPv6 Routing؟',back:'show ipv6 route',ex:'جميع مسارات IPv6 على الجهاز.'},
      {front:'عرض جيران الطبقة 3؟',back:'show arp',ex:'يُظهر IP↔MAC للـ Next-Hop ضمن الـ LAN.'},
      {front:'عرض الواجهات بإيجاز؟',back:'show ip interface brief',ex:'حالة الواجهات وعناوينها بسرعة.'},
      {front:'البوابة الأخيرة في الإخراج؟',back:'Gateway of Last Resort',ex:'يظهر ضمن show ip route عند وجود Default.'},
      {front:'تحقّق من التوجيه نحو إنترنت؟',back:'ping 8.8.8.8',ex:'اختبار وصول عبر Default/المسارات العامة.'},
      {front:'تتبّع المسار؟',back:'traceroute',ex:'يعرض القفزات Hops باستخدام TTL/ICMP.'},
      {front:'عرض البروتوكولات؟',back:'show ip protocols',ex:'يسرد الديناميكية الفعّالة (إن وجدت).'},

      // D) Theory + Scenarios
      {front:'Recursive Lookup يعني…',back:'بحث متكرر',ex:'يبحث عن مسار للـ Next‑Hop غير المباشر.'},
      {front:'AD الأقل يربح أم Metric؟',back:'AD أولاً',ex:'المفاضلة بين المصادر تتم بـ AD قبل Metric.'},
      {front:'ما الفرق NAT vs Routing؟',back:'ترجمة/توجيه',ex:'NAT يغيّر العناوين؛ Routing يختار المسار فقط.'},
      {front:'Proxy ARP يوفّر…',back:'رد بالنيابة',ex:'يسمح بجسر عناوين خارج الشبكة المحلية أحيانًا.'},
      {front:'ICMP Redirect يفيد في…',back:'تصحيح المسار',ex:'ينبّه المضيف لبوابة أفضل لوجهة ما.'},
      {front:'Route to Null0 يحمي من…',back:'الحلقات',ex:'يمنع الدوران الناتج عن تلخيص غير دقيق.'},
      {front:'SVI مقابل L3 Port‑Channel؟',back:'داخلي/موجّه',ex:'SVI داخل السويتش؛ Port‑Channel L3 يربط أجهزة.'},
      {front:'VRF (Virtual Routing & Forwarding)…',back:'جداول متعدّدة',ex:'عزل جداول توجيه متعددة على جهاز واحد.'},
      {front:'Policy‑Based Routing (PBR)…',back:'توجيه بسياسة',ex:'اختيار المسار وفق سياسات (ACL/Ports)، لا فقط LPM.'},
      {front:'Administrative Distance لـ OSPF؟',back:'110',ex:'مقارنةً بـ Static=1 وRIP=120.'},

      // E) IPv6 specifics
      {front:'افتراضي IPv6؟',back:'::/0',ex:'يؤدي إلى البوابة الافتراضية IPv6 Default Gateway.'},
      {front:'Link‑Local في IPv6؟',back:'fe80::/10',ex:'تُستخدم كـ Next-Hop داخل الوصلة غالبًا.'},
      {front:'Neighbor Discovery (NDP)…',back:'بديل ARP',ex:'اكتشاف الجيران عبر ICMPv6 (NS/NA).'},
      {front:'Loopback IPv6؟',back:'::1',ex:'العنوان المحلي للجهاز نفسه.'},
      {front:'Show Neighbor Cache؟',back:'show ipv6 neighbors',ex:'يعرض جيران IPv6 المُكتشفين (NDP).'},
      {front:'Static IPv6 إلى مضيف؟',back:'/128',ex:'تحديد عنوان مقصد واحد بالتمام.'},
      {front:'Route Preference في IPv6؟',back:'مكافئ AD',ex:'تفضيل مصدر المسار في بعض الأنظمة.'},
      {front:'RA/RS ترتبط بـ…',back:'ICMPv6',ex:'تعلِم المضيفين Default Router وPrefixes.'},
      {front:'توحيد IPv4/IPv6؟',back:'Dual‑Stack',ex:'تشغيل البروتوكولين معًا على نفس الشبكة.'},
      {front:'Traceroute6؟',back:'traceroute -6',ex:'تتبّع المسار في بيئة IPv6.'},

      // F) Commands (practice)
      {front:'أضف مسارًا ثابتًا 10.10.20.0/24 عبر 192.0.2.1',back:'ip route 10.10.20.0 255.255.255.0 192.0.2.1',ex:'Static IPv4 إلى شبكة /24 عبر Next-Hop.'},
      {front:'أضف Default IPv4 عبر 203.0.113.254',back:'ip route 0.0.0.0 0.0.0.0 203.0.113.254',ex:'بوابة الإنترنت الافتراضية.'},
      {front:'أضف IPv6 Default عبر fe80::1 على G0/0',back:'ipv6 route ::/0 fe80::1 GigabitEthernet0/0',ex:'استخدام Link‑Local مع الواجهة.'},
      {front:'تحقق من Static فقط',back:'show ip route static',ex:'فلترة جدول IPv4 للنوع S.'},
      {front:'ابحث عن مسار لـ 198.51.100.10',back:'show ip route 198.51.100.10',ex:'تحليل الـ LPM والـ AD للمسار المختار.'},
      {front:'اعرض Gateway of Last Resort',back:'show ip route | inc Gateway',ex:'يتحقق من تعيين Default.'},
      {front:'اعرض ARP Cache',back:'show ip arp',ex:'خريطة IP↔MAC للمجاورين.'},
      {front:'اعرض ملخّص المسارات',back:'show ip route summary',ex:'إجمالي الإدخالات حسب المصدر.'},
      {front:'احذف مسار 172.16.40.0/24 عبر 10.0.0.1',back:'no ip route 172.16.40.0 255.255.255.0 10.0.0.1',ex:'إزالة إدخال ثابت محدد.'},
      {front:'ارفَع AD لمسار احتياطي إلى 200',back:'ip route NET MASK NH 200',ex:'Floating Static Route.'},

      // G) Troubleshooting
      {front:'لا يظهر Default في الجدول… السبب؟',back:'غياب التكوين',ex:'أو تعارض AD/Interface Down أو Next‑Hop غير قابل للوصول.'},
      {front:'Ping يعمل داخل LAN ولا يعمل خارجها…',back:'لا يوجد Default',ex:'أو ACL/NAT يمنعان الخروج.'},
      {front:'Route موجود لكن لا Forwarding…',back:'ARP/Neighbor',ex:'فشل حل الـ Next‑Hop على الطبقة 2.'},
      {front:'ازدواج مسارات غير مرغوب…',back:'تلخيص خاطئ',ex:'عالج بالـ Null0 أو دقة التلخيص.'},
      {front:'تذبذب المسارات (Flapping)…',back:'رابط غير مستقر',ex:'شخّص بالـ Logs وInterface Counters.'},
      {front:'عدم توازن ECMP جيدًا…',back:'Hashing',ex:'بعض التدفقات تبقى على رابط واحد — وهذا متوقع.'},
      {front:'IPv6 Next‑Hop غير صحيح…',back:'Link‑Local',ex:'تأكد من الواجهة المصاحبة مع العنوان المحلي.'},
      {front:'ICMP Redirect غير مرغوب…',back:'أمنيًا',ex:'يُعطّل غالبًا لمنع التلاعب.'},
      {front:'مسار ثابت لا يُستخدم رغم وجوده…',back:'LPM/AD',ex:'هناك مسار أكثر تحديدًا أو AD أقل.'},
      {front:'انقطاع عند فشل رابط واحد…',back:'لا ECMP/No Backup',ex:'أضف Floating Static أو رابط ثانٍ.'},

      // H) Mixed T/F quick
      {front:'المسار C يتطلب Next‑Hop.',back:'لا',ex:'هو متصل مباشرة.'},
      {front:'يمكن لـ Default توجيه كل شيء.',back:'نعم',ex:'عدا الوجهات التي لها تطابق أطول.'},
      {front:'AD يقرر داخل البروتوكول نفسه.',back:'لا',ex:'AD بين البروتوكولات؛ Metric داخل البروتوكول.'},
      {front:'IPv6 يستخدم ARP.',back:'لا',ex:'يستخدم NDP (ICMPv6).'},
      {front:'ECMP يعمل مع Static فقط.',back:'لا',ex:'يعمل مع Static وDynamic.'},
      {front:'Route إلى Null0 يُسقِط المرور عمداً.',back:'نعم',ex:'للحماية من الدوران أو التسريب.'},
      {front:'LPM يتجاهل AD.',back:'نعم',ex:'أولاً يطابق الأطول ثم ينظر للـ AD/Metric.'},
      {front:'يمكن أن يعلن الراوتر Default عبر OSPF.',back:'نعم',ex:'default-information originate.'},
      {front:'يجب أن تتطابق واجهات IPv6 في الـ MTU.',back:'نعم',ex:'اختلاف MTU قد يسبب إسقاط الحزم.'},
      {front:'VRF يسمح بجداول توجيه متعددة.',back:'نعم',ex:'عزل منطقي على نفس الجهاز.'}
    ];

    // ===== 2) عناصر DOM =====
    const els = {
      front: document.getElementById('front'), back: document.getElementById('back'), card: document.getElementById('card'),
      idx: document.getElementById('idx'), total: document.getElementById('total'), bar: document.getElementById('bar'),
      btnFlip: document.getElementById('btnFlip'), btnPrev: document.getElementById('btnPrev'), btnNext: document.getElementById('btnNext'),
      btnGood: document.getElementById('btnGood'), btnBad: document.getElementById('btnBad'), btnShuffle: document.getElementById('btnShuffle'),
      exBox: document.getElementById('ex'), exText: document.getElementById('exText'), timer: document.getElementById('timer'),
      mins: document.getElementById('mins'), btnStartQuiz: document.getElementById('btnStartQuiz'), quizInfo: document.getElementById('quizInfo'),
      quizSetup: document.getElementById('quizSetup'), quizView: document.getElementById('quizView'), qFront: document.getElementById('qFront'),
      qidx: document.getElementById('qidx'), qtotal: document.getElementById('qtotal'), score: document.getElementById('score'),
      ansInput: document.getElementById('ansInput'), btnSubmit: document.getElementById('btnSubmit'), btnSkip: document.getElementById('btnSkip'),
      quizFeedback: document.getElementById('quizFeedback'), quizTimer: document.getElementById('quizTimer'), tfBtns: document.getElementById('tfBtns'),
      btnTrue: document.getElementById('btnTrue'), btnFalse: document.getElementById('btnFalse'), quizSummary: document.getElementById('quizSummary'),
      summaryText: document.getElementById('summaryText'), btnRetry: document.getElementById('btnRetry'), btnBackStudy: document.getElementById('btnBackStudy'),
      studyView: document.getElementById('studyView')
    };

    // ===== 3) منطق الدراسة =====
    let i = 0; const STORAGE_KEY = 'routing-expanded-90-known-v1'; let known = new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'));

    function updateExplain(){ const flipped = els.card.classList.contains('flipped'); const hasEx = !!cards[i].ex; if(flipped && hasEx){ els.exText.textContent = cards[i].ex; els.exBox.classList.remove('hidden'); } else { els.exBox.classList.add('hidden'); els.exText.textContent = ''; } }
    function render(){ els.total.textContent = cards.length; els.idx.textContent = i + 1; els.front.textContent = cards[i].front; els.back.textContent  = cards[i].back; const progress = (known.size / cards.length) * 100; els.bar.style.width = progress + '%'; els.card.classList.remove('flipped'); updateExplain(); }
    function flip(){ els.card.classList.toggle('flipped'); updateExplain(); }
    function next(){ i = (i + 1) % cards.length; els.card.classList.remove('flipped'); render(); }
    function prev(){ i = (i - 1 + cards.length) % cards.length; els.card.classList.remove('flipped'); render(); }
    function markKnown(){ known.add(i); localStorage.setItem(STORAGE_KEY, JSON.stringify([...known])); next(); }
    function markUnknown(){ known.delete(i); localStorage.setItem(STORAGE_KEY, JSON.stringify([...known])); next(); }
    function shuffle(){ for(let j = cards.length - 1; j > 0; j--){ const k = Math.floor(Math.random() * (j + 1)); [cards[j], cards[k]] = [cards[k], cards[j]]; } i = 0; els.card.classList.remove('flipped'); render(); }

    els.btnFlip.addEventListener('click', flip);
    els.btnNext.addEventListener('click', next);
    els.btnPrev.addEventListener('click', prev);
    els.btnGood.addEventListener('click', markKnown);
    els.btnBad.addEventListener('click', markUnknown);
    els.btnShuffle.addEventListener('click', shuffle);

    document.addEventListener('keydown', (e)=>{
      if(e.code === 'Space'){ e.preventDefault(); flip(); }
      else if(e.key === 'ArrowRight'){ next(); }
      else if(e.key === 'ArrowLeft'){ prev(); }
      else if(e.key === '1'){ markKnown(); }
      else if(e.key === '2'){ markUnknown(); }
    });

    // ===== 4) وضع الاختبار =====
    let quiz = { order: [], idx: 0, score: 0, total: 0, running: false, endAt: 0, tHandle: null };

    function normalize(s){ return (s||'').toString().trim().toLowerCase().replace(/[\u200f\u200e]/g,'').replace(/[\u0610-\u061a\u064b-\u065f\u06d6-\u06ed]/g,'').replace(/[–—−]/g,'-').replace(/\s+/g,' '); }
    const synonyms = { 'صح':['صح','نعم','true'], 'لا':['لا','خطأ','false'], '0.0.0.0/0':['0.0.0.0/0','default','default route'], '::/0':['::/0','ipv6 default'] };
    function eq(a,b){ a=normalize(a); b=normalize(b); if(a===b) return true; if((b==='نعم'&& (a==='صح'||a==='نعم')) || (b==='لا'&&(a==='خطأ'||a==='لا'))) return true; for(const k in synonyms){ if(b===k && synonyms[k].includes(a)) return true; } return false; }

    function startTimer(mins){ const ms = mins*60*1000; quiz.endAt = Date.now()+ms; updateTimer(); quiz.tHandle = setInterval(updateTimer, 250); }
    function stopTimer(){ if(quiz.tHandle){ clearInterval(quiz.tHandle); quiz.tHandle=null; } els.quizTimer.textContent='—'; }
    function updateTimer(){ const remain = Math.max(0, quiz.endAt - Date.now()); const m = Math.floor(remain/60000); const s = Math.floor((remain%60000)/1000); els.quizTimer.textContent = `${m}:${String(s).padStart(2,'0')}`; els.timer.textContent = `⏱️ ${m}:${String(s).padStart(2,'0')}`; if(remain<=0){ finishQuiz(); } }

    function show(el){ el.classList.remove('hidden'); }
    function hide(el){ el.classList.add('hidden'); }

    function beginQuiz(){
      quiz.order = Array.from(cards.keys());
      for(let j = quiz.order.length-1; j>0; j--){ const k = Math.floor(Math.random()*(j+1)); [quiz.order[j], quiz.order[k]] = [quiz.order[k], quiz.order[j]]; }
      quiz.idx = 0; quiz.score = 0; quiz.total = quiz.order.length; quiz.running = true; els.qtotal.textContent = quiz.total;
      els.score.textContent = '0'; els.qidx.textContent = '1'; els.quizFeedback.textContent = '';
      hide(els.quizSetup); show(els.quizView); hide(els.quizSummary); hide(els.studyView);
      loadQuestion();
      const mins = Math.max(1, Math.min(60, parseInt(els.mins.value||'12',10)));
      startTimer(mins);
      els.quizInfo.textContent = `تم بدء اختبار بـ ${mins} دقيقة`;
    }

    function loadQuestion(){
      const idx = quiz.order[quiz.idx]; const c = cards[idx];
      els.qFront.textContent = c.front; els.ansInput.value=''; els.ansInput.focus();
      const b = normalize(c.back);
      if(b === 'صح' || b === 'خطأ' || b==='نعم' || b==='لا'){ show(els.tfBtns); } else { hide(els.tfBtns); }
    }

    function checkAnswer(userAns){
      const idx = quiz.order[quiz.idx]; const c = cards[idx];
      const a = normalize(userAns); let b = normalize(c.back);
      if(['yes','صح','نعم','true'].includes(b)) b='نعم';
      if(['no','خطأ','لا','false'].includes(b)) b='لا';
      const ok = (a===b) || eq(a,b);
      if(ok){ quiz.score++; els.quizFeedback.innerHTML = '✅ إجابة صحيحة'; }
      else{ els.quizFeedback.innerHTML = `❌ الصحيح: <span class="kbd">${c.back}</span>` + (c.ex? `<br/><span class="small muted">${c.ex}</span>`:''); }
      els.score.textContent = String(quiz.score);
      quiz.idx++;
      if(quiz.idx >= quiz.total){ finishQuiz(); }
      else { els.qidx.textContent = String(quiz.idx+1); loadQuestion(); }
    }

    function finishQuiz(){
      if(!quiz.running) return;
      quiz.running = false; stopTimer();
      hide(els.quizView); show(els.quizSummary);
      const percent = Math.round((quiz.score/quiz.total)*100);
      els.summaryText.innerHTML = `أنهيت الاختبار: <strong>${quiz.score}</strong> من <strong>${quiz.total}</strong> — الدرجة: <strong>${percent} / 100</strong>`;
    }

    // روابط أحداث الاختبار
    document.getElementById('btnStartQuiz').addEventListener('click', beginQuiz);
    document.getElementById('btnSubmit').addEventListener('click', ()=>{ checkAnswer(els.ansInput.value); });
    document.getElementById('btnSkip').addEventListener('click', ()=>{ checkAnswer('___'); });
    document.getElementById('btnTrue').addEventListener('click', ()=> checkAnswer('نعم'));
    document.getElementById('btnFalse').addEventListener('click', ()=> checkAnswer('لا'));
    document.getElementById('btnRetry').addEventListener('click', ()=>{ show(els.quizSetup); hide(els.quizSummary); hide(els.studyView); });
    document.getElementById('btnBackStudy').addEventListener('click', ()=>{ show(els.studyView); hide(els.quizSetup); hide(els.quizSummary); stopTimer(); });

    // ===== 5) Self-tests (Console) =====
    (function selfTests(){
      const tests=[]; function t(name,fn){ try{ fn(); tests.push({name,ok:true}); } catch(e){ tests.push({name,ok:false,msg:e.message}); } }
      t('cards length = 90', ()=>{ if(!Array.isArray(cards) || cards.length!==90) throw new Error('يجب أن يكون عدد البطاقات 90'); });
      t('front/back نصوص', ()=>{ cards.forEach(c=>{ if(typeof c.front!=='string'||typeof c.back!=='string') throw new Error('front/back يجب أن تكون نصوص'); }); });
      t('ex ≤ سطرين', ()=>{ cards.forEach(c=>{ if(c.ex && c.ex.length>240) throw new Error('شرح طويل'); }); });
      console.log('%c[Routing Expanded 90] Self-tests:','color:#7dd3fc');
      tests.forEach(r=> console.log(r.ok? '✅ '+r.name : '❌ '+r.name+' — '+r.msg));
    })();

    // بدء العرض
    render();
  </script>
</body>
</html>
